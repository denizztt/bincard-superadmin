package com.bincard.bincard_superadmin;

import javafx.application.Platform;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardWatchEventKinds;
import java.nio.file.WatchEvent;
import java.nio.file.WatchKey;
import java.nio.file.WatchService;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.function.Consumer;
import com.google.gson.Gson;
import com.google.gson.JsonSyntaxException;

/**
 * Web form'dan JavaFX'e veri aktarÄ±mÄ± iÃ§in utility class
 * HTML sayfalarÄ±ndan gelen form verilerini otomatik olarak JavaFX panellerine aktarÄ±r
 */
public class WebToJavaFXBridge {
    
    private static final String DATA_FILE_NAME = "bincard_payment_point_data.json";
    private static final String DOWNLOADS_FOLDER = System.getProperty("user.home") + "/Downloads";
    private static final Path DATA_FILE_PATH = Paths.get(DOWNLOADS_FOLDER, DATA_FILE_NAME);
    
    private static WatchService watchService;
    private static boolean isWatching = false;
    private static Consumer<PaymentPointData> dataCallback;
    
    /**
     * Web form'dan gelen veri modeli
     */
    public static class PaymentPointData {
        public String name;
        public String description;
        public double latitude;
        public double longitude;
        public String address;
        public String street;
        public String district;
        public String city;
        public String postalCode;
        public String contact;
        public String startTime;
        public String endTime;
        public String[] paymentMethods;
        public boolean active;
        public String timestamp;
        public long id;
        
        @Override
        public String toString() {
            return String.format("PaymentPointData{name='%s', lat=%f, lng=%f, address='%s'}", 
                               name, latitude, longitude, address);
        }
    }
    
    /**
     * Web form'dan gelen verileri dinlemeye baÅŸlar
     * @param callback Yeni veri geldiÄŸinde Ã§aÄŸrÄ±lacak callback fonksiyonu
     */
    public static void startWatching(Consumer<PaymentPointData> callback) {
        if (isWatching) {
            System.out.println("âš ï¸ Zaten web verilerini dinliyoruz");
            return;
        }
        
        dataCallback = callback;
        
        CompletableFuture.runAsync(() -> {
            try {
                watchService = Paths.get(DOWNLOADS_FOLDER).getFileSystem().newWatchService();
                Paths.get(DOWNLOADS_FOLDER).register(watchService, StandardWatchEventKinds.ENTRY_MODIFY);
                
                isWatching = true;
                System.out.println("ğŸ‘€ Web form verileri dinleniyor: " + DATA_FILE_PATH);
                
                while (isWatching) {
                    WatchKey key = watchService.take();
                    
                    for (WatchEvent<?> event : key.pollEvents()) {
                        if (event.kind() == StandardWatchEventKinds.ENTRY_MODIFY) {
                            Path fileName = (Path) event.context();
                            
                            if (fileName.toString().equals(DATA_FILE_NAME)) {
                                System.out.println("ğŸ“¥ Web form verisi algÄ±landÄ±: " + fileName);
                                
                                // KÄ±sa bir gecikme - dosya yazÄ±mÄ±nÄ±n tamamlanmasÄ± iÃ§in
                                Thread.sleep(1000);
                                
                                processNewWebData();
                            }
                        }
                    }
                    
                    key.reset();
                }
                
            } catch (Exception e) {
                System.err.println("âŒ Web veri dinleme hatasÄ±: " + e.getMessage());
                isWatching = false;
            }
        });
    }
    
    /**
     * Web form veri dinlemeyi durdurur
     */
    public static void stopWatching() {
        isWatching = false;
        if (watchService != null) {
            try {
                watchService.close();
                System.out.println("ğŸ›‘ Web veri dinleme durduruldu");
            } catch (IOException e) {
                System.err.println("âŒ Watch service kapatma hatasÄ±: " + e.getMessage());
            }
        }
    }
    
    /**
     * Yeni web verilerini iÅŸler
     */
    private static void processNewWebData() {
        try {
            if (!Files.exists(DATA_FILE_PATH)) {
                System.out.println("âš ï¸ Veri dosyasÄ± bulunamadÄ±: " + DATA_FILE_PATH);
                return;
            }
            
            String jsonContent = Files.readString(DATA_FILE_PATH);
            Gson gson = new Gson();
            
            // JSON array olarak parse et
            PaymentPointData[] dataArray = gson.fromJson(jsonContent, PaymentPointData[].class);
            
            if (dataArray != null && dataArray.length > 0) {
                // En son eklenen veriyi al (en yÃ¼ksek ID'li)
                PaymentPointData latestData = dataArray[0];
                for (PaymentPointData data : dataArray) {
                    if (data.id > latestData.id) {
                        latestData = data;
                    }
                }
                
                System.out.println("ğŸ†• Yeni web verisi iÅŸleniyor: " + latestData);
                
                // UI thread'de callback'i Ã§aÄŸÄ±r
                if (dataCallback != null) {
                    Platform.runLater(() -> {
                        try {
                            dataCallback.accept(latestData);
                            System.out.println("âœ… Web verisi JavaFX'e aktarÄ±ldÄ±");
                        } catch (Exception e) {
                            System.err.println("âŒ Callback hatasÄ±: " + e.getMessage());
                        }
                    });
                }
            }
            
        } catch (JsonSyntaxException e) {
            System.err.println("âŒ JSON parse hatasÄ±: " + e.getMessage());
        } catch (IOException e) {
            System.err.println("âŒ Dosya okuma hatasÄ±: " + e.getMessage());
        } catch (Exception e) {
            System.err.println("âŒ Web veri iÅŸleme hatasÄ±: " + e.getMessage());
        }
    }
    
    /**
     * Mevcut web verilerini manuel olarak kontrol et
     */
    public static PaymentPointData[] readExistingWebData() {
        try {
            if (!Files.exists(DATA_FILE_PATH)) {
                System.out.println("ğŸ“„ HenÃ¼z web verisi yok: " + DATA_FILE_PATH);
                return new PaymentPointData[0];
            }
            
            String jsonContent = Files.readString(DATA_FILE_PATH);
            Gson gson = new Gson();
            
            PaymentPointData[] dataArray = gson.fromJson(jsonContent, PaymentPointData[].class);
            
            System.out.println("ğŸ“Š Mevcut web verisi sayÄ±sÄ±: " + (dataArray != null ? dataArray.length : 0));
            
            return dataArray != null ? dataArray : new PaymentPointData[0];
            
        } catch (Exception e) {
            System.err.println("âŒ Mevcut web verisi okuma hatasÄ±: " + e.getMessage());
            return new PaymentPointData[0];
        }
    }
    
    /**
     * Token dosyasÄ±nÄ± oluÅŸturur (web sayfasÄ± iÃ§in)
     */
    public static void createTokenFile(TokenDTO accessToken) {
        try {
            String userHome = System.getProperty("user.home");
            Path tokenPath = Paths.get(userHome, "token_temp.txt");
            
            if (accessToken != null && accessToken.getToken() != null) {
                Files.write(tokenPath, accessToken.getToken().getBytes());
                System.out.println("ğŸ”‘ Token dosyasÄ± oluÅŸturuldu: " + tokenPath);
            } else {
                Files.write(tokenPath, "dummy-token".getBytes());
                System.out.println("âš ï¸ GeÃ§ersiz token, dummy token yazÄ±ldÄ±: " + tokenPath);
            }
            
        } catch (IOException e) {
            System.err.println("âŒ Token dosyasÄ± oluÅŸturma hatasÄ±: " + e.getMessage());
        }
    }
    
    /**
     * Web sayfasÄ± iÃ§in token injection script'ini gÃ¼nceller
     */
    public static void updateTokenScript(TokenDTO accessToken) {
        try {
            Path scriptPath = Paths.get("token_inject.js");
            
            String scriptContent = String.format(
                """
                // Token injection script - JavaFX tarafÄ±ndan gÃ¼ncellenmiÅŸ
                console.log('ğŸ”‘ Token injection script yÃ¼klendi (JavaFX gÃ¼ncellemesi)');
                
                // Global token deÄŸiÅŸkeni
                let token = '%s';
                
                // Firebase konfigÃ¼rasyonu
                window.FIREBASE_CONFIG = {
                    projectId: 'bincard-9a335',
                    apiKey: 'AIzaSyBRYfrvFsxgARSM_iE7JA1EHu1nSpaWAxc',
                    serviceAccount: 'firebase-adminsdk-fbsvc@bincard-9a335.iam.gserviceaccount.com'
                };
                
                // Token'Ä± localStorage'a kaydet
                localStorage.setItem('bincard_auth_token', token);
                
                // Global deÄŸiÅŸkenler
                window.authToken = token;
                window.API_BASE_URL = 'http://localhost:8080/v1/api';
                window.GOOGLE_MAPS_API_KEY = 'AIzaSyBRYfrvFsxgARSM_iE7JA1EHu1nSpaWAxc';
                
                console.log('âœ… JavaFX token gÃ¼ncellendi:', token.substring(0, 20) + '...');
                """, 
                accessToken != null ? accessToken.getToken() : "dummy-token"
            );
            
            Files.write(scriptPath, scriptContent.getBytes());
            System.out.println("ğŸ”„ Token script gÃ¼ncellendi: " + scriptPath);
            
        } catch (IOException e) {
            System.err.println("âŒ Token script gÃ¼ncelleme hatasÄ±: " + e.getMessage());
        }
    }
    
    /**
     * Test metodu - bridge'in Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol eder
     */
    public static void testBridge() {
        System.out.println("ğŸ§ª Web-JavaFX Bridge testi baÅŸlÄ±yor...");
        System.out.println("ğŸ“ Veri dosyasÄ± yolu: " + DATA_FILE_PATH);
        System.out.println("ğŸ“‚ Downloads klasÃ¶rÃ¼: " + DOWNLOADS_FOLDER);
        
        PaymentPointData[] existingData = readExistingWebData();
        System.out.println("ğŸ“Š Mevcut veri sayÄ±sÄ±: " + existingData.length);
        
        System.out.println("âœ… Bridge test tamamlandÄ±");
    }
}
